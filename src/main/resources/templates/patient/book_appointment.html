<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments :: head('Запись на приём')}"></head>
<body>
<div th:replace="~{fragments :: navbar}"></div>
<div th:replace="~{fragments :: alert}"></div>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center">
        <h2>Записаться на прием</h2>
        <a href="/patient" class="btn btn-secondary">Назад в кабинет</a>
    </div>

    <form th:object="${appointment}" th:action="@{/patient/appointments/book}" method="post" class="mt-3">
        <input type="hidden" th:field="*{patientId}" />

        <div class="mb-3">
            <label class="form-label">Врач *</label>
            <select class="form-select" id="doctorSelect" required>
                <option value="">Выберите врача</option>
                <option th:each="d : ${doctors}"
                        th:value="${d.id}"
                        th:text="${d.user?.fullName + ' (' + d.specialization + ')'}">
                </option>
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">Дата и время приема *</label>
            <select class="form-select" id="slotSelect" name="scheduleId" required>
                <option value="">Выберите дату и время</option>
            </select>
        </div>
        <input type="hidden" id="doctorIdField" name="doctorId" />
        <button type="submit" class="btn btn-success">Записаться</button>
        <a href="/patient" class="btn btn-secondary ms-2">Отмена</a>
    </form>
</div>

<script>
    document.getElementById('doctorSelect').addEventListener('change', function () {
        const doctorId = this.value;
        const slotSelect = document.getElementById('slotSelect');
        const doctorIdField = document.getElementById('doctorIdField');
        doctorIdField.value = doctorId;
        slotSelect.innerHTML = '<option value="">Выберите дату и время</option>';
        if (!doctorId) return;

        fetch(`/patient/appointments/slots?doctorId=${doctorId}`)
            .then(response => response.json())
            .then(slots => {
                slots.forEach(slot => {
                    const option = document.createElement('option');
                    option.value = slot.id;
                    const date = new Date(slot.date);
                    const dateStr = date.toLocaleDateString('ru-RU');
                    const timeStr = slot.time.substring(0, 5);

                    option.textContent = `${dateStr} ${timeStr} — ${slot.doctorFullName} (${slot.specialization})`;
                    slotSelect.appendChild(option);
                });
            })
            .catch(err => {
                console.error('Ошибка загрузки слотов:', err);
                slotSelect.innerHTML = '<option value="">Ошибка загрузки</option>';
            });
    });
</script>

<div th:replace="~{fragments :: footer}"></div>
</body>
</html>